---
title: "Plotting"
author: "Michael Dumelle, Tony Olsen, Tom Kincaid, and Marc Weber"
output: 
  html_document:
    theme: flatly
    number_sections: true
    highlighted: default 
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Plotting}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE, 
  message = FALSE
)
```

This vignette covers plotting in `spsurvey` using the `NE_Lakes` data. Plotting in `spsurvey` largely builds on plotting functionality in `sf`, and any arguments you can normally specify in `sf` plotting system, you can specify in `spsurvey`'s. For more background, we recommend reading the `sf`'s [Plotting Simple Features](https://r-spatial.github.io/sf/articles/sf5.html) vignette and running `?plot.sf`.  This vignette is separated into two sections. The first, [Plotting Sample Frames], covers plotting your sample frames and is most useful before selecting your probability sample. The second, [Plotting Design Object] covers plotting your design object (sample frame and sampled sites) and should be used after a probability sample is selected.

If you have not yet done so, please stop and read the "Start Here" vignette, accessed by running `vignette("start_here", package = "spsurvey")`. 

# Plotting Sample Frames

Before anything else, you must load `spsurvey` by running
```{r}
library(spsurvey)
```

If you want to reproduce the results from code in this vignette, you must also set a seed by running
```{r}
set.seed(5.0)
```

It is often quite useful to visualize your sample frame before selecting a probability sample. Perhaps you want to want to select a stratified sample, an unequal probabiltiy sample, a proportional probability sample, or some combination of these, and you need a better understanding of the relationship among the variables for which you have access. In this vignette, you will use the `NE_Lakes` data which contains information on 5328 lakes in the northeastern part of the United States of America. 
```{r}
data("NE_Lakes")
```

To view the first few rows, run
```{r}
head(NE_Lakes)
```
You will notice that along with attributes, spatial information has been returned for the data:

* `geometry type`: This is a `POINT` geometry because each lake has a set of `x` and `y` coordinates.
* `dimension`: There are two dimensions, `X` (east-west) and `Y` (north-south).
* `bbox`: The bounding box of the spatial locations.
* `projected CRS`: The coordinates in a USA Contiguous Albers Equal Area Conic Projection.

The next few lines describe variables in `NE_Lakes`; for more regarding the `NE_Lakes` data and associated variables, run `?NE_Lakes`.

Next we will visualize the `NE_Lakes` data. But before doing so, we need store the data as an `sframe` (short for "sample frame") object:
```{r}
NE_Lakes <- sframe(NE_Lakes)
```

Now you are ready to use `spsurvey`'s plot commands. 

## Categorical Variable Distributions

When plotting categorical variables, the `object` and `formula` arguments must be specified: `object` is your `sframe` object and `formula` provides the variables to be plotted. For now, we use a one-sided formula (`~ variables`) to visualize categorical variables. These types of plots can be useful to determine the spatial layout of strata or uneuqal probability groups before selecting a sample.

To plot the `ELEVATION_CAT` variable, run
```{r}
plot(NE_Lakes, formula = ~ ELEVATION_CAT, key.pos = 1)
```

The `key.pos` argument to `sf` controls the placement of the legend (1 = bottom, 2 = left, 3 = top, 4 = right). The default in `sf` is `key.pos = 4`, but we will override this default and use `key.pos = 1` throughout the rest of the vignette.

To change any graphical parameters, such as plotting symbol or size, simply pass those arguments to `plot()`. For example, if you want to plot `x`'s instead of open circles, run
```{r}
plot(NE_Lakes, formula = ~ ELEVATION_CAT, pch = 4, key.pos = 1)
```

You will notice that this changes the symbol for **all points**. But what if you want to plot small, open circles for the low elevation level and large, `x`'s for the high elevation level? To do this, you must use the `varlevel_args` argument (short for a variable's **level** arguments) in `plot()`. `varlevel_args` is a named list containing with sublists whose name equal of each variable to be adjusted and whose values indicate the levels of the categorical variable as well as the associated graphical parameters.
```{r}
varlevel_args <- list(
  ELEVATION_CAT = list(
    levels = c("low", "high"),
    pch = c(1, 4),
    cex = c(1, 2)
  )
)
plot(NE_Lakes, formula = ~ ELEVATION_CAT, varlevel_args = varlevel_args, key.pos = 1)
```

If you specify a graphical parameter using in this way, values be provided **for all levels** of the variable. Later you will use the `var_args` argument to pass a single argument to all levels of a variable.

If you want to use `sf`'s default values for a graphical parameter, simply pass `NA` as an argument. For example, suppose you want to use `sf`'s default values for the graphical parameters of the `"low"` level of `ELEVATION_CAT`, but you want to change the graphical parameters for the `"high"` level of `ELEVATION_CAT`:
```{r}
varlevel_args <- list(
  ELEVATION_CAT = list(
    levels = c("low", "high"),
    pch = c(NA, 2),
    cex = c(NA, 2)
  )
)
plot(NE_Lakes, formula = ~ ELEVATION_CAT, varlevel_args = varlevel_args, key.pos = 1)
```

The graphical parameters that can be given `NA` values to match `sf` defaults must correspond to variables for which `sf` has relevant **pre-established defaults**: `pch`, `cex`, `col`, `bg`, `lwd`, `lty`, `typ`, `border`, and `rule`. Run `plot.sf()` for more information about default graphical parameter values.

To plot multiple categorical variables, simply add them to the formula using `+` signs between variables:
```{r}
plot(NE_Lakes, formula = ~ AREA_HA_CAT + ELEVATION_CAT, key.pos = 1)
```

When plotting multiple variables, you will be asked to step through each plot by R (`Hit <Return> to see next plot:`).

If you want to simultaneously pass plotting arguments **to all levels of each variable**, use the `var_args` argument (short for variable arguments). Suppose you want the `AREA_HA_CAT` plot to have open circles, the standard color palette, and a custom title. Also suppose you want the `ELEVATION_CAT` plot to have `x`'s, the rainbow color palette, and the deafult title. To specify this, run
```{r}
var_args <- list(
  AREA_HA_CAT = list(pch = 1, main = "This is a fun custom title!"),
  ELEVATION_CAT = list(pch = 4, pal = rainbow)
)
plot(
  NE_Lakes,
  formula = ~ AREA_HA_CAT + ELEVATION_CAT,
  var_args = var_args,
  key.pos = 1
)
```

To plot combinations of categorical variables, separate the variables in the formula using `:`. This tells `spsurvey` to create a new variable containing four levels (the combination of the two levels for `AREA_HA_CAT` and `ELEVATION_CAT`) and plot them. These new variables are represented in the figure legend using `:`. For example, `small:low` is the sites in the small area level and the low elevation level. To create this plot, run 
```{r}
plot(NE_Lakes, formula = ~ AREA_HA_CAT:ELEVATION_CAT, key.pos = 1)
```

To plot the previous three plots using a single command, leverage `R`'s formula structure and the `*` operator. The code `plot(NE_Lakes, AREA_HA_CAT * ELEVATION_CAT, key.pos = 1)` is equivalent to `plot(NE_Lakes, ~ AREA_HA_CAT + ELEVATION_CAT + AREA_HA_CAT:ELEVATION_CAT, key.pos = 1)`.

You can plot a single level of a single variable using the `onlyshow` argument. If an interaction is specified, the levels in `onlyshow` must correspond to the levels in the formula (in order):
```{r}
plot(
  NE_Lakes,
  formula = ~ AREA_HA_CAT:ELEVATION_CAT,
  onlyshow = "small:high",
  key.pos = 1
)
```


## Plotting Geometries

You will notice that previously, all observations are placed on the sample plot. Perhaps it is of interest to plot levels of categorical variables **on separate plots**, and this is what we cover next. First, you can plot the geometry of all sites in `NE_Lakes` by running
```{r}
plot(NE_Lakes)
```

To plot the geometry for each elevation level, you will use the `geom` argument, which tells `spsurvey` to plot the geometries -- one plot for each level of `ELEVATION_CAT`:
```{r}
plot(NE_Lakes, formula = ~ ELEVATION_CAT, geom = TRUE)
```

Or you can plot a single level using the `onlyshow` argument:
```{r}
plot(NE_Lakes, formula = ~ ELEVATION_CAT, geom = TRUE, onlyshow = "high")
```

Certianly additional arguments like `var_args` or `varlevel_args` can be specified. Geometries can only be plotted when the left hand side of the formula is empty.

## Categorical Response by Categorical Variables

It is also possible to plot a categorical response variable **for different levels** of other categorical variables. This can be done by placing a categorical response variable on the left hand side of the formula argument and the other categorical variables on the right hand side. For example, to plot `AREA_HA_CAT` (response variable) for each separate level of `ELEVATION_CAT` (other variable), run
```{r}
plot(NE_Lakes, formula = ELEVATION_CAT ~ AREA_HA_CAT, key.pos = 1)
```

Graphical arguments for `ELEVATION_CAT` (response) can vary based on `AREA_HA_CAT` (other variable). Graphical arguments for different levels of the `ELEVATION_CAT` (response variable) must be provided in the `var_args` argument and by consequence, must remain consistent for each of these levels of `AREA_HAT_CAT` (other variable). Graphical arguments for `AREA_HA_CAT` (other variable) that do not depend on the levels of the `ELEVATION_CAT` (response variable), however, may vary by `AREA_HA_CAT` (other variable) levels.
```{r}
var_args <- list(
  AREA_HA_CAT = list(
    ELEVATION_CAT = list(levels = c("low", "high"), pch = c(1, 4))
  )
)
varlevel_args <- list(
  AREA_HA_CAT = list(levels = c("small", "large"), cex = c(1, 2))
)
plot(
  NE_Lakes,
  formula = ELEVATION_CAT ~ AREA_HA_CAT,
  var_args = var_args,
  varlevel_args = varlevel_args,
  key.pos = 1
)
```

## Continuous Response by Categorical Variables

You can also plot continuous variables in `spsurvey`. To plot the `ELEVATION` variable, run
```{r}
plot(NE_Lakes, formula = ELEVATION ~ 1, key.pos = 1)
```


You can also plot a continuous variable **for different levels** of other categorical variables. This can be done by putting the continuous response variable on the left hand side of the formula argument:
```{r}
plot(NE_Lakes, formula = ELEVATION ~ AREA_HA_CAT, key.pos = 1)
```

One example of where these type of visualization could be useful is before proportional probability sampling: In this context, sampling proportionally to `AREA_HA`.

You will notice that the color scales are not fixed for each level of `AREA_HA_CAT`. Fixing them can be achieved through the `var_args` argument by passing a color scale to all levels of `AREA_HA_CAT`:
```{r}
var_args <- list(
  AREA_HA_CAT = list(breaks = seq(0, 600, by = 50))
)
plot(
  NE_Lakes,
  formula = ELEVATION ~ AREA_HA_CAT,
  var_args = var_args,
  key.pos = 1
)
```

Passing unique color scales to each level of `AREA_HA_CAT` requires the `varlevel_args` argument.

# Plotting Design Objects

`spsurvey` also lets you visualize your probability samples in combination with your sample frame. Suppose you select a GRTS sample of size 200 from `NE_Lakes`:
```{r}
sample <- grts(NE_Lakes, n_base = 200)
```

To visualize the sampled sites overalain on the sample frame, run
```{r}
plot(sample, NE_Lakes, pch = 19, key.pos = 1)
```

In this context, the explicit default formula called is `~ sites`, where `sites` references each type of observation (a sample frame element or a base site element). It is helpful to think about this plot similarly to plots from [Categorical Variable Distributions], where `sites` is just a right hand side variable.

To plot just the geometries, simply use the `geom` argument:
```{r}
plot(sample, NE_Lakes, geom = TRUE)
```

To adjust graphical parameters, use `varlevel_args` -- here we plot the sample frame sites with open cicles and the base sites with closed circles:
```{r}
varlevel_args <- list(
  sites = list(levels = c("sframe", "sites_base"), pch = c(1, 19))
)
plot(sample, NE_Lakes, varlevel_args = varlevel_args, key.pos = 1)
```

If you want to plot only the base sites, the sample frame need not be specified:
```{r}
plot(sample, key.pos = 1)
```

If you want to plot each level of the `sites` argument by a cateogrical variable, similar to plots from [Categorical Response by Categorical Variables], run
```{r}
plot(sample, NE_Lakes, sites ~ ELEVATION_CAT, pch = 19, key.pos = 1)
```

To plot closed circles for the base sites, run
```{r}
var_args <- list(
  ELEVATION_CAT = list(
    sites = list(levels = c("sframe", "sites_base"), pch = c(1, 19))
  )
)
plot(
  sample,
  NE_Lakes,
  sites ~ ELEVATION_CAT,
  var_args = var_args,
  key.pos = 1
)
```

To visualize a numeric variable for each level of `sites`, similar to [Continuous Response by Categorical Variables], run
```{r}
plot(sample, NE_Lakes, AREA_HA ~ sites, key.pos = 1)
```

Now suppose you use `spsurvey` to select another sample of 200 while also specifying a 100 replacement sites (using the revese heirarchical ordering method) in case some of your original sites can't be sampled:
```{r}
sample2 <- grts(NE_Lakes, n_base = 200, n_over = 100)
```

To visualize the sample frame (small, open circles), base sites (closed circles), and replacement sites (closed circles), run
```{r}
varlevel_args <- list(
  sites = list(
    levels = c("sframe", "sites_base", "sites_over"),
    pch = c(1, 19, 19),
    cex = c(0.5, 1, 1)
  )
)
plot(sample2, NE_Lakes, varlevel_args = varlevel_args, key.pos = 1)
```