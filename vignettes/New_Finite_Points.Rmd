---
title: "Selecting and Analyzing Finite Population Designs using the spsurvey R package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{New_Finite_Points}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE, 
  message = FALSE
)
set.seed(1)
```

# Finite Designs

In this vignette, you will learn how to:

* Select a variety of probability samples using the GRTS algorithm.
* Analyze those probability samples.

First, you will load the `spsurvey` package:
```{r setup}
# loading spsurvey
library(spsurvey)
```

You will explore the NLA Lakes 2007 dataset throughout this vignette. More information can be found using `?NLA_2007`.
```{r load NLA}
# loading the data
data(NLA_2007)

# printing the first few rows
head(NLA_2007)
```

Beforing moving forward, we must store this data as an `sf` object. For more information about converting your data to an `sf` object, please visit the INSERT NAME vignette using INSERT VIGNETTE ACCESS CODE.

```{r}
# storing the data frame as an sf object
NLA_2007 <- st_as_sf(NLA_2007, coords = c("xcoord", "ycoord"), crs = 5069)
```

You will only a few of the column variables throughout this vignette. To subset the data, run:
```{r}
# subsetting the data to include relevant columns
NLA_2007 <- NLA_2007[, c("siteID", "wgt", "Lake_Origin", "Chla_cond", "Chla")]
```


```{r, include = FALSE}
# this will get taken out once I realize how to use the proper functions
pathgrts <- "C:/Users/mdumelle/Documents/grts_dev/grts_pts_test/test_07032020/"
source(paste0(pathgrts, "grtspts.R"))
source(paste0(pathgrts, "grtspts_returnused.R"))
source(paste0(pathgrts, "grtspts_ip.R"))
source(paste0(pathgrts, "grtspts_stratum.R"))
source(paste0(pathgrts, "grtspts_ipleg.R"))
source(paste0(pathgrts, "grtspts_select.R"))
source(paste0(pathgrts, "grtspts_mindis.R"))
source(paste0(pathgrts, "make_grid.R"))
source(paste0(pathgrts, "numLevels.R"))
source(paste0(pathgrts, "cellWeight.R"))
source(paste0(pathgrts, "dsgn_check.R"))
source(paste0(pathgrts, "stopprnt.R"))
source(paste0(pathgrts, "warnprnt.R"))
source(paste0(pathgrts, "constructAddr.R"))
source(paste0(pathgrts, "ranho.R"))
source(paste0(pathgrts, "pickGridCells.R"))
source(paste0(pathgrts, "pickFiniteSamplePoints.R"))
source(paste0(pathgrts, "replace_sites.R"))
```

## Using the GRTS Algorithm


The GRTS algorithm is a flexible tool you can use for a variety of contexts. You will first learn a variety of selection methods for single-strata designs:

* Equal probability of selection.
* Unequal probability of selection.
* Probability of selection proportional to an auxiliary variable.

You will then use the same selection methods for stratified designs.  Then, you use some of the additional features available in the GRTS algorithm to learn how to:

* Incorporate legacy sites (existing sites).
* Ensure a minimum distance between any two sites.
* Select replacement sites in the event that you are unable to visit originally sampled sites.

### Single-Strata Designs

#### Equal Probability of Selection

To select an equal proability GRTS sample, run:
```{r}
# equal probability design
eqprob <- grtspts(sframe = NLA_2007, seltype = "equal", nsamp = 30)
```
The function arguments are:

* `sframe` the `sf` object
* `seltype` the type of selection. `seltype = "equal"` is the default, so this argument did not need to be explicitly specified.
* `nsamp` the desired sample size

The output is a list containing two objects: `sites:base` and `dsgn`. `sites:base` is an `sf` object containing information about the sample.
```{r}
# storing the sites:base information
eqprob_sites <- eqprob$sites.base
# printing the first few rows
eqprob_sites
```

* The rownames of `eqprob_sites` match the rows locations from the original `sf` object. 
* `siteID` is the ID used to identify the ordering of sites in the GRTS sample.  This is a different variable than the `siteID` from the original `sf` object. These indices can be accessed with and used to recover the original site ID's using 
`NLA_2007[as.numeric(rownames(eqprob_sites)), "siteID"]`
* `replsite` is NA for all rows because we did not implement the replacement site option.  
* `siteuse` is `"Base"` for all rows because these samples are all part of the base sample (i.e. there are no replacement sites)
* `stratum` equals `None` for all rows because this is not a stratified design
* `wgt` is the vector of probability weights indicating the number of population units the site represents (equal to $N/n$, where $N$ is the number of population units and $n$ is the sample size). This is a different variable than the `wgt` from the original `sf` object.
* `ip` is the vector of inclusion probabilities indicating the probability of each unit being selected in the design (equal to $n/N$)
* `caty` equals `None` for all rows because this design does not incorporate unequal selection probabilities
* `aux` is NA for all rows because we did not implement the auxiliary site option for proportional sampling. 
* `legacy` is NA for all rows because we did not implement the legacy site option.  
* The rest of the variables are from the original `sf` object.

`dsgn` is a list containing information about the design specificiations. You should use this to verify the algorithm used reflects the intended design.

```{r}
# storing the design information
eqprob_dsgn <- eqprob$dsgn

# printing the output
eqprob_dsgn
```

* `stratum_var` The stratum variable in `eqprob_sites` indicating the name of the stratum variable.
* `caty_var`: The unequal probability variable in `eqprob_sites`.
* `aux_var` The auxiliary variabile `eqprob_sites` for proportional sampling.
* `legacy_var` The legacy variable in `eqprob_sites`.
* `stratum` The names of the strata
* `seltype` The selection type for each strata
* `nsamp` The sample size for each strata
* `caty.n` The expected sample size for each unequal probability category within each strata
* `over.n` The number of replacement sites using method1 for each strata
* `over.near`The number of replacement sites using method2 for each strata
* `mindis` The minimum distance between sites for each strata

#### Unequal Probability of Selection

Suppose we want to sample natural lakes twice as often as man-made lakes. To select an unequal probability GRTS sample, run:
```{r}
# expected sample size for each group
caty.n <- c(20, 10)
# names of the categories
names(caty.n) <- c("Natural", "Man-Made")
# selecting the unequal probability sample
uneqprob <- grtspts(sframe = NLA_2007, seltype = "unequal", 
                          nsamp = 30, caty_var = "Lake_Origin", 
                          caty.n = caty.n)
```

The new function arguments are:

* `caty_var`: A character vector specifying the name of the variable containing the unequal probability categories.
* `caty.n`: A character vector specifying the number of expected samples for each unequal probability category. This vector must be named, and the names must match the names the `"Lake_Origin"` variable of `NLA_2007`.

`uneqprob$sites.base` and `uneqprob$dsgn` contain the sampled site and design information, respectively.

#### Probability of Selection Proportional to an Auxiliary Variable

It is useful to sample proportional to a continuous auxiliary variable when there is a positive correlation between the response variable and the auxiliary variable because this can yield more precise estimates. To select a sample proportional to a continuous auxiliary variable, run:

```{r, include = FALSE}
# selection probability proportional to the Chla variable 
propprob <- grtspts(sframe = NLA_2007, seltype = "proportional", 
                          nsamp = 30, aux_var = "Chla") 

```

The new function arguments are:

* `aux_var`: A categorical variable specifying the continuous variable in `NLA_2007` to use for proportional selection.

`propprob$sites.base` and `propprob$dsgn` contain the sampled site and design information, respectively.

### Stratified Designs

#### Equal Probability of Selection

To select a stratified GRTS sample with equal probabilities of selection within strata, run:

```{r}
# names of the strata
strata <- c("Natural", "Man-Made")
# sample sizes of the strata
strata.n <- c(15, 15)
# selecting the stratified, equal probability sample
strat_eqprob <- grtspts(sframe = NLA_2007, stratum_var = "Lake_Origin",
                        stratum = strata, seltype = "equal", 
                        nsamp = strata.n)
```

The new function arguments are:

* `stratum_var`: The name of the strata variable in `NLA_2007`.
* `stratum`: The names of the strata in `"Lake_Origin"`
* `nsamp`: A vector whose elements specify the sample size in each strata as defined by the `stratum` argument

`strat_eqprob$sites.base` and `strat_eqprob$dsgn` contain the sampled site and design information, respectively.

#### Unequal Probability of Selection

To select a stratified GRTS sample with unequal (and possibly varying) unequal probabilities within strata, run:
```{r}
# names of the strata
strata <- c("Natural", "Man-Made")
# sample sizes of the strata
strata.n <- c(15, 15)
# expected number of samples in the natural strata for the Chla_cond variable
natural_caty.n <- c(9, 6)
# names of the Chla_cond variable
names(natural_caty.n) <- c("Good", "Poor")
# expected number of samples in the man-made strata for the Chla_cond variable
manmade_caty.n <- c(7, 8)
# names of the Chla_cond variable
names(manmade_caty.n) <- c("Good", "Poor")
# list of the unequal probability expected samples for each strata
caty.n_list <- list(natural_caty.n, manmade_caty.n)
# names of the strata
names(caty.n_list) <- c("Natural", "Man-Made")
# selecting the stratified, unequal probability sample
strat_uneqprob <- grtspts(sframe = NLA_2007, stratum_var = "Lake_Origin",
                        stratum = strata, seltype = "unequal", 
                        nsamp = strata.n, caty_var = "Chla_cond", 
                        caty.n = caty.n_list)
```

The new function arguments are:

* `caty_var`: The variable in the dataset for the unequal probability categories
* `caty.n`: A list whose names match the names of the `stratum` variable.  The elements of the list are vectors whose entries represent the expected sample sizes for the unequal probability classes within strata.  The names of these vectors must equal the names of the unqeual probability categories.

`strat_uneqprob$sites.base` and `strat_uneqprob$dsgn` contain the sampled site and design information, respectively.

#### Probability of Selection Proportional to an Auxiliary Variable

To select a stratified GRTS sample where each strata is sampled proportionally to a continuous auxiliary variable, run:

```{r}
# selecting the stratified, proportional probability sample
strat_propprob <-  grtspts(sframe = NLA_2007, stratum_var = "Lake_Origin",
                        stratum = strata, seltype = "proportional", 
                        nsamp = strata.n, aux_var = "Chla")
```

The new function arguments are:

* `aux_var`: The auxiliary variable in the dataset

`strat_propprob$sites.base` and `strat_propprob$dsgn` contain the sampled site and design information, respectively. It is not currently possible to choose different auxiliary variables for different strata.

### Incorporating Legacy Sites

A legacy site is a site that must be selected in the sample.  Often, legacy sites are used because they have been previously sampled or their inclusion is important for a specific reason.  We focus on legacy sites that have been previously obtained as part of a probability sample. For purposes of illustration, we will add a new variable, `legacy`, which treats 10 randomly selected sites as legacy sites.

```{r}
NLA_2007$legacy <- FALSE
NLA_2007$legacy[sample(1:nrow(NLA_2007), size = 10)] <- TRUE
```

To include legacy sites in an unstratified, unequal probability sample, run:
```{r}
eqprob_legacy <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         legacy_var = "legacy")
```

The new function argument is `"legacy"`, which specifies the name of the legacy variable in the `sf` object. 

`eqprob_legacy$sites.base` and `eqprob_legacy$dsgn` contain the sampled site and design information, respectively. It is possible you encounter a warning message saying `Of the x grid cells from which sample poits were selected, y (y/x%) of the cells contained more than one sample point.  This warning message exists because sometimes the requirement that legacy sites must be included prevents the sample from being as spread out as a sample from a standard GRTS algorithm.

### Incorporating Minimum Distance

The standard GRTS algorithm may select sites that are closer together than desired. You can adjust the algorithm to incorporate some minimum distance between sites.  Supppose we requires sites be 43,208.78 meters apart, which is 0.01 quantile of all possible distances between population units in the `NLA_2007` dataset.

```{r}
mindis <- 43208.78
```

To include the minimum distance requirement in an unstratified, equal probability design, run:
```{r}
eqprob_mindis <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         mindis = mindis)
```

The new function argument is `mindis`, which specifies the minimum distance requirement.

It is possible that the GRTS algorithm will not be able to ensure the minimum distance is met for all sampled sites.  In this context, the algorithm will attempt to ensure the minimum distance is met for as many sites as possible and return a warning stating that the requirement was not met after 10 attempts.

### Replacement Sites

It is often of interest to select a number of replacement sites that can be used if sites selected from the GRTS algorithm are unable to be sampled.  This can happen for a variety of reasons: landowner deinial, lack of funding, lack of resources, to name a few. We discuss two methods of selecting replacment sites you can specify in the GRTS algorithm. 

#### Method 1 - Reverse Heirarchical Ordering

The first method of selecting replacement sites follows Stevens and Olsen (2004). The sample size $n$, and the number of replacement sites, $n_r$, are pre-specified. The GRTS algorithm then selects a sample of $n + n_r$.  These sites are placed in reverse heirarchical order and then first $n$ are considered part of the base sample and the next $n_r$ are the replacement sites. To incorporate this method of selecting replacement sites in an unstratified, equal probability design, run:
```{r}
eqprob_replace1 <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         over.n = 10)
```

The new function argument is `over.n`, which equals $n_r$, the number of required replacement sites.

The `eqprob_replace1$sites.base` `sf` object still contains the information for the $n$ base samples. The `eqprob_replace1$sites.over` `sf` object is now non-NULL, and contains information for the $n_r$ replacement sites.

#### Method 2 - GRTS Subsetting

The second method of selecting replacement sites follows Dumelle et al (2020). The sample size $n$ is prespecified. Instead of selecting random locations as replacement sites, this method assigns replacement sites using locations that are nearby each site that cannot be sampled. For each site in teh base sample, you may choose up to 10 additional sites, which are randomly ordered, to use as replacement sites if that particular site in the base sample cannot be sampled. As long as there are enough sites, each replacement site can be combined with the base site the entire sample may viewed as a GRTS sample. This is not true for Method 1, because the method for replacement sites gives a subset of the original GRTS sample, which is not usually a GRTS sample. To incorporate this method of selecting replacement sites in an unstratified, equal probability design, run:
```{r}
eqprob_replace2 <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         over.near = 10, over.n = 10)
```

The new function argument is `over.n`, which equals the number of replacement sites desired for each base site.

The `eqprob_replace2$sites.base` `sf` object still contains the information for the $n$ base samples. The `eqprob_replace2$sites.near` `sf` object is now non-NULL, and contains information for the replacement sites.  The `replsite` variable indicates what base site the original site is replacing, and the `siteuse` variable indicates the order replacement sites should be used for the base site. 

#### Combining Method 1 and Method 2 for Replacement Sites

Method 1 and Method 2 have their own drawbacks in specifying the replacement sites. For Method 1, you must prespecify the number of replacement sites.  It is not possible to generate additional replacement sites after the sample is selected, so it may not be feasible to attain the desired sample size.  For Method 2, it is possible there are not enough replacement sites for each base site.  These drawbacks can be overcome by combining Method 1 and Method 2 and running:
```{r}
eqprob_replace12 <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         over.near = 10, over.n = 10)
```

The `eqprob_replace2$sites.over` and `eqprob_replace2$sites.near` are now both non-NULL. We recommend using Method 2's replacement sites if possible.  If using Method 2's replacement sites is not possible, you can add Method 1's replacement sites. 

## Analyzing Probability Samples