---
title: "Selecting and Analyzing Finite Population Designs using the spsurvey Package"
output: 
  html_document:
    theme: spacelab
    highlighted: default 
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{New_Finite_Points}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE, 
  message = FALSE
)
pathgrts <- "C:/Users/mdumelle/Documents/grts_dev/grts_pts_test/test_07032020/"
source(paste0(pathgrts, "grtspts.R"))
source(paste0(pathgrts, "grtspts_returnused.R"))
source(paste0(pathgrts, "grtspts_ip.R"))
source(paste0(pathgrts, "grtspts_stratum.R"))
source(paste0(pathgrts, "grtspts_ipleg.R"))
source(paste0(pathgrts, "grtspts_select.R"))
source(paste0(pathgrts, "grtspts_mindis.R"))
source(paste0(pathgrts, "make_grid.R"))
source(paste0(pathgrts, "numLevels.R"))
source(paste0(pathgrts, "cellWeight.R"))
source(paste0(pathgrts, "dsgn_check.R"))
source(paste0(pathgrts, "stopprnt.R"))
source(paste0(pathgrts, "warnprnt.R"))
source(paste0(pathgrts, "constructAddr.R"))
source(paste0(pathgrts, "ranho.R"))
source(paste0(pathgrts, "pickGridCells.R"))
source(paste0(pathgrts, "pickFiniteSamplePoints.R"))
source(paste0(pathgrts, "replace_sites.R"))
```

# Introduction

The `spsurvey` packges provides easily accessible functions used to select Generalized Random Tesselation Stratified (GRTS) probability samples (Stevens and Olsen, 2004). GRTS was developed to select samples that are spatially balanced and representative of the population. GRTS can accomodate  finite, linear, and areal designs. In this vignette, you will focus on applying GRTS to finite designs and analyzing the associated probability samples. Specifically, you will explore:

* The Structure of the `NLA_2007` [Data] 
* [The `grtspts` Function]
    * [Arguments]
    * [Output]
* [Single-Strata Designs]
* [Stratified Designs]
* [Additional Design Features]
    * [Legacy Sites]
    * [Minimum Distance Between Sites]
    * [Replacement Sites]
* [Analyzing GRTS Probability Samples]

If this is your first time using the `spsurvey` package, you will need to run:
```{r, eval = FALSE}
install.packages("spsurvey")
```
to install the package. Next, you will load the `spsurvey` package:
```{r setup}
library(spsurvey)
```
If you want to replicate the results in the vignette exactly, run:
```{r}
set.seed(1)
```

# Data

You will use the NLA Lakes 2007 dataset throughout this vignette. More information can be found by running `?NLA_2007`. To load the data into your workspace, run:
```{r load NLA}
data(NLA_2007)
```
To view the first few rows, run:
```{r}
head(NLA_2007)
```

Beforing moving forward, you will need to store the data as an `sf` object by running:
```{r}
# storing the data frame as an sf object
NLA_2007 <- st_as_sf(NLA_2007, coords = c("xcoord", "ycoord"), crs = 5069)
```
For more information about converting your data to an `sf` object, please visit the INSERT NAME vignette using INSERT VIGNETTE ACCESS CODE. 

# The `grtspts` Function 

## Arguments

You will use the `grtspts` function to select your GRTS probability sample. There are several arguments to the GRTS function you can specify. Some of the arguments include:

* `sframe`: The dataset, which must be an `sf` object.
* `seltype`: The selection probability type.
* `nsamp`: The sample size.
* `stratum`: The strata categories.
* `stratum_var`: The name of the stratum variable in `sframe`.
* `caty_var`: The name of the groups in `sframe` if `seltype = "unequal"`.
* `aux_var`: The name of the auxiliary variable in `sframe` if `seltype = "proportional"`.
* `legacy_var`: The name of the legacy variable in `sframe`.
* `caty.n`: The expected sample size for each group if `seltype = "unequal"`.
* `over.n`: The number of replacement sites using [Method 1 - Reverse Heirarchical Ordering].
* `over.near`: The number of replacement sites using [Method 2 - GRTS Subsetting].

Additional arguments influence specific parts of the GRTS algorithm's behavior and are not related to the design properties. For more information on these additional arguments, run `?grtspts`.

## Output

The `grtspts` function returns a list with four sub-lists: `sites.base`, `sites.over`, `sites.near`, and `dsgn`. `sites.base` contains information about the sites selected in the base GRTS sample. You can also select [Replacement Sites] to use if the sites in your base sample can no longer be sampled.  Sites may not be able to be sampled due to landowner denial, a lack of resources, or some other reason. `sites.over` and `sites.near` contain information about replacement sites. `dsgn` contains information about the design. This should be checked to make sure that the `grtspts` function returns the output you intended. More information about `sites.base`, `sites.over`, `sites.near`, and `dsgn` is provided below.


The `sites.base` list returns information regarding the sites selected in the base GRTS sample. `sites.base` is an `sf` object having the same geomertry type and CRS as your dataset. The rownames of `sites.base` equal the row locations from your dataset. `sites.base` contains variables from your dataset as well as several new variables:

* `siteID`: A site identifier for all sites from the base GRTS sample [Data].
* `relpsite`: Contains replacement site information . This variable will always be `NA` in `sites.base`. It is more important `sites.near`, which we explore later. This variable is included in `sites.base` to facilitate easy row binding of `sites.base` and `sites.near`.
* `siteuse`: Contains information about whether the site is in the base sample or is a replacement site. 
* `stratum`: Contains information about the site's stratum.
* `wgt`: Contains the survey design weights.
* `ip`: Contains the inclusion probabilities.
* `caty`: Contains the unequal probability categories.
* `aux`: Contains the auxiliary variable information.
* `legacy`: Contains the legacy site indicator.

The `sites.over` list returns the same columns as `sites.base`, but `sites.over` returns information for relacement sites generated using [Method 1 - Reverse Heirarchical Ordering]. This sub-list is `NULL` if `over.n` is not an argument to `grtspts`.

The `sites.near` list returns the same columns as `sites.base`, but `sites.near` returns information for relacement sites generated using [Method 2 - GRTS Subsetting]. This sub-list is `NULL` if `over.near` is not an argument to `grtspts`.

The `dsgn` list

# Single-Strata Designs

## Equal Probability

To select an equal proability GRTS sample, run:
```{r}
# equal probability design
eqprob <- grtspts(sframe = NLA_2007, seltype = "equal", nsamp = 30)
```

The non-NULL `dsgn` output is:
```{r, echo = FALSE}
for (s in names(eqprob$dsgn)) {
    if (length(Filter(Negate(is.null), eqprob$dsgn[[s]])) == 0) eqprob$dsgn[[s]] <- NULL
}
eqprob$dsgn
```

## Unequal Probability

Suppose we want to sample natural lakes twice as often as man-made lakes. To select an unequal probability GRTS sample, run:
```{r}
# expected sample size for each group
caty.n <- c(20, 10)
# names of the categories
names(caty.n) <- c("Natural", "Man-Made")
# selecting the unequal probability sample
uneqprob <- grtspts(sframe = NLA_2007, seltype = "unequal", 
                          nsamp = 30, caty_var = "Lake_Origin", 
                          caty.n = caty.n)
```

The non-NULL `dsgn` output is:
```{r, echo = FALSE}
for (s in names(uneqprob$dsgn)) {
    if (length(Filter(Negate(is.null), uneqprob$dsgn[[s]])) == 0) uneqprob$dsgn[[s]] <- NULL
}
uneqprob$dsgn
```

## Proportional Probability

It is useful to sample proportional to a continuous auxiliary variable when there is a positive correlation between the response variable and the auxiliary variable because this can yield more precise estimates. To select a sample proportional to a continuous auxiliary variable, run:

```{r}
# selection probability proportional to the Chla variable 
propprob <- grtspts(sframe = NLA_2007, seltype = "proportional", 
                          nsamp = 30, aux_var = "Chla") 

```

The non-NULL `dsgn` output is:
```{r, echo = FALSE}
for (s in names(propprob$dsgn)) {
    if (length(Filter(Negate(is.null), propprob$dsgn[[s]])) == 0) propprob$dsgn[[s]] <- NULL
}
propprob$dsgn
```

# Stratified Designs

## Equal Probability

To select a stratified GRTS sample with equal probabilities of selection within strata, run:

```{r}
# names of the strata
strata <- c("Natural", "Man-Made")
# sample sizes of the strata
strata.n <- c(15, 15)
# selecting the stratified, equal probability sample
strat_eqprob <- grtspts(sframe = NLA_2007, stratum_var = "Lake_Origin",
                        stratum = strata, seltype = "equal", 
                        nsamp = strata.n)
```

The non-NULL `dsgn` output is:
```{r, echo = FALSE}
for (s in names(strat_eqprob$dsgn)) {
    if (length(Filter(Negate(is.null), strat_eqprob$dsgn[[s]])) == 0) strat_eqprob$dsgn[[s]] <- NULL
}
strat_eqprob$dsgn
```

## Unequal Probability

To select a stratified GRTS sample with unequal (and possibly varying) unequal probabilities within strata, run:
```{r}
# names of the strata
strata <- c("Natural", "Man-Made")
# sample sizes of the strata
strata.n <- c(15, 15)
# expected number of samples in the natural strata for the Chla_cond variable
natural_caty.n <- c(9, 6)
# names of the Chla_cond variable
names(natural_caty.n) <- c("Good", "Poor")
# expected number of samples in the man-made strata for the Chla_cond variable
manmade_caty.n <- c(7, 8)
# names of the Chla_cond variable
names(manmade_caty.n) <- c("Good", "Poor")
# list of the unequal probability expected samples for each strata
caty.n_list <- list(natural_caty.n, manmade_caty.n)
# names of the strata
names(caty.n_list) <- c("Natural", "Man-Made")
# selecting the stratified, unequal probability sample
strat_uneqprob <- grtspts(sframe = NLA_2007, stratum_var = "Lake_Origin",
                        stratum = strata, seltype = "unequal", 
                        nsamp = strata.n, caty_var = "Chla_cond", 
                        caty.n = caty.n_list)
```

The non-NULL `dsgn` output is:
```{r, echo = FALSE}
for (s in names(strat_uneqprob$dsgn)) {
    if (length(Filter(Negate(is.null), strat_uneqprob$dsgn[[s]])) == 0) strat_uneqprob$dsgn[[s]] <- NULL
}
strat_uneqprob$dsgn
```

## Proportional Probability

To select a stratified GRTS sample where each strata is sampled proportionally to a continuous auxiliary variable, run:

```{r}
# selecting the stratified, proportional probability sample
strat_propprob <-  grtspts(sframe = NLA_2007, stratum_var = "Lake_Origin",
                        stratum = strata, seltype = "proportional", 
                        nsamp = strata.n, aux_var = "Chla")
```

The non-NULL `dsgn` output is:
```{r, echo = FALSE}
for (s in names(strat_propprob$dsgn)) {
    if (length(Filter(Negate(is.null), strat_propprob$dsgn[[s]])) == 0) strat_propprob$dsgn[[s]] <- NULL
}
strat_propprob$dsgn
```

# Additional Design Features

## Legacy Sites

A legacy site is a site that must be selected in the sample.  Often, legacy sites are used because they have been previously sampled or their inclusion is important for a specific reason.  We focus on legacy sites that have been previously obtained as part of a probability sample. For purposes of illustration, we will add a new variable, `legacy`, which treats 10 randomly selected sites as legacy sites.

```{r}
NLA_2007$legacy <- FALSE
NLA_2007$legacy[sample(1:nrow(NLA_2007), size = 10)] <- TRUE
```

To include legacy sites in an unstratified, unequal probability sample, run:
```{r}
eqprob_legacy <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         legacy_var = "legacy")
```

The new function argument is `"legacy"`, which specifies the name of the legacy variable in the `sf` object. 

`eqprob_legacy$sites.base` and `eqprob_legacy$dsgn` contain the sampled site and design information, respectively. It is possible you encounter a warning message saying `Of the x grid cells from which sample poits were selected, y (y/x%) of the cells contained more than one sample point.  This warning message exists because sometimes the requirement that legacy sites must be included prevents the sample from being as spread out as a sample from a standard GRTS algorithm.

## Minimum Distance Between Sites

The standard GRTS algorithm may select sites that are closer together than desired. You can adjust the algorithm to incorporate some minimum distance between sites.  Supppose we requires sites be 43,208.78 meters apart, which is 0.01 quantile of all possible distances between population units in the `NLA_2007` dataset.

```{r}
mindis <- 43208.78
```

To include the minimum distance requirement in an unstratified, equal probability design, run:
```{r}
eqprob_mindis <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         mindis = mindis)
```

The new function argument is `mindis`, which specifies the minimum distance requirement.

It is possible that the GRTS algorithm will not be able to ensure the minimum distance is met for all sampled sites.  In this context, the algorithm will attempt to ensure the minimum distance is met for as many sites as possible and return a warning stating that the requirement was not met after 10 attempts.

## Replacement Sites

It is often of interest to select a number of replacement sites that can be used if sites selected from the GRTS algorithm are unable to be sampled.  This can happen for a variety of reasons: landowner deinial, lack of funding, lack of resources, to name a few. We discuss two methods of selecting replacment sites you can specify in the GRTS algorithm. 

### Method 1 - Reverse Heirarchical Ordering

The first method of selecting replacement sites follows Stevens and Olsen (2004). The sample size $n$, and the number of replacement sites, $n_r$, are pre-specified. The GRTS algorithm then selects a sample of $n + n_r$.  These sites are placed in reverse heirarchical order and then first $n$ are considered part of the base sample and the next $n_r$ are the replacement sites. To incorporate this method of selecting replacement sites in an unstratified, equal probability design, run:
```{r}
eqprob_replace1 <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         over.n = 10)
```

The new function argument is `over.n`, which equals $n_r$, the number of required replacement sites.

The `eqprob_replace1$sites.base` `sf` object still contains the information for the $n$ base samples. The `eqprob_replace1$sites.over` `sf` object is now non-NULL, and contains information for the $n_r$ replacement sites.

### Method 2 - GRTS Subsetting

The second method of selecting replacement sites follows Dumelle et al (2020). The sample size $n$ is prespecified. Instead of selecting random locations as replacement sites, this method assigns replacement sites using locations that are nearby each site that cannot be sampled. For each site in teh base sample, you may choose up to 10 additional sites, which are randomly ordered, to use as replacement sites if that particular site in the base sample cannot be sampled. As long as there are enough sites, each replacement site can be combined with the base site the entire sample may viewed as a GRTS sample. This is not true for Method 1, because the method for replacement sites gives a subset of the original GRTS sample, which is not usually a GRTS sample. To incorporate this method of selecting replacement sites in an unstratified, equal probability design, run:
```{r}
eqprob_replace2 <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         over.near = 10, over.n = 10)
```

The new function argument is `over.n`, which equals the number of replacement sites desired for each base site.

The `eqprob_replace2$sites.base` `sf` object still contains the information for the $n$ base samples. The `eqprob_replace2$sites.near` `sf` object is now non-NULL, and contains information for the replacement sites.  The `replsite` variable indicates what base site the original site is replacing, and the `siteuse` variable indicates the order replacement sites should be used for the base site. 

### Combining Method 1 and Method 2 for Replacement Sites

Method 1 and Method 2 have their own drawbacks in specifying the replacement sites. For Method 1, you must prespecify the number of replacement sites.  It is not possible to generate additional replacement sites after the sample is selected, so it may not be feasible to attain the desired sample size.  For Method 2, it is possible there are not enough replacement sites for each base site.  These drawbacks can be overcome by combining Method 1 and Method 2 and running:
```{r}
eqprob_replace12 <- grtspts(NLA_2007, seltype = "equal", nsamp = 30,
                         over.near = 10, over.n = 10)
```

The `eqprob_replace2$sites.over` and `eqprob_replace2$sites.near` are now both non-NULL. We recommend using Method 2's replacement sites if possible.  If using Method 2's replacement sites is not possible, you can add Method 1's replacement sites. 

# Analyzing GRTS Probability Samples

# References

Stevens Jr, D. L. and Olsen, A. R. (2004). Spatially balanced sampling of natural resources.
*Journal of the American Statistical Association*, 99(465):262-278.