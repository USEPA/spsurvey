---
title: "Analyzing Probability Samples for Point Resources (Finite Population)"
author: "Michael Dumelle, Tony Olsen, Tom Kincaid, and Marc Weber"
output: 
  rmarkdown::html_document:
    theme: flatly
    number_sections: true
    highlighted: default 
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Analyzing Probability Samples for Point Resources (Finite Population)}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE, 
  message = FALSE
)
```


# Introduction

In this vignette, you will use spsurvey to analyze probability samples for the `NLA_West` data, which represents a subset of lakes from EPA's National Lakes ASsessment (NLA). There are two main analysis types this vignette covers: categorical variable analysis using the `cat_analysis()` function and continuous variable analysis using the `cont_analysis()` function. 

There are two types of data objects that can be used with these functions: an `sf` object or a standard `data.frame`. If an `sf` object is used, the `xcoord` and `ycoord` arguments to the `cat_analysis()` and `cont_analysis()` functions are not required. There are several other optional arguments available to `cat_analysis()` and `cont_analysis()` that provide further customization of your analysis; you can run `?cat_analysis()` and `?cont_analysis()` for more information.

Next, you will explore:

* [The `NLA_West` Data]
    * [Categorical variable analysis using `cat_analysis()`]
    * [Continuous variable analysis using `cont_analysis()`]

There are a few analysis types this vignette will not cover at the current time (though they may be added later): risk analysis using the `attrisk_analysis()` and `relrisk_analysis()` functions, change analyis using the `change_analysis()` function, and cumulative distribution function (CDF) analysis using the `cont_cdftest()` function. For more information regarding these functions, visit their help pages by running `?functionname` (e.g. `?attrisk_analysis()`).

If you have not yet done so, please stop and read the "Start Here" vignette, accessed by running `vignette("start_here", package = "spsurvey")`. 

# The `NLA_West` Data

Before anything else, you must load `spsurvey` by running
```{r}
library(spsurvey)
```

Then, you can load the `NLA_West` data by running 
```{r}
data("NLA_West")
```

Before using these analysis functions, if you want to create basic summaries of your data you must turn it into a `dframe` (design frame) object:
```{r}
NLA_West <- dframe(NLA_West)
```

Suppose we wanted to summarize the number of sampled lakes that were from the target population (`TNT_CAT`):
```{r}
summary(NLA_West, ~ TNT_CAT)
```

For more information regarding the `NLA_West` data, run `?NLA_West`.

## Categorical variable analysis using `cat_analysis()`

The `cat_analysis()` function returns a data frame containing a suite of information regarding the categorical variable in question. Each row contains information regarding several variables; see `?cat_analysis()` for more information.

First you will estimate the extent (numbers of lakes) that are in the target population.
```{r}
tnt_extent <- cat_analysis(
  dframe = NLA_West,
  vars = "TNT_CAT",
  weight = "WGT_TP_EXTENT",
  xcoord = "XCOORD",
  ycoord = "YCOORD",
  popcorrect = TRUE
)
```

* `dframe` is `NLA_West`, the design frame.
* `vars` is `"TNT_CAT"` the variable representing the `Target` vs `NonTarget` lakes.
* `weight` is `"WGT_TP_EXTENT"`, the weight representing extent in the target population.
* `xcoord` is the  x-coordinate (longitude) in `dframe` (this does not need to be supplied if `dframe` is also an `sf` object).
* `ycoord` is the  x-coordinate (latitude) in `dframe` (this does not need to be supplied if `dframe` is also an `sf` object).
* `popcorrect` indicates a finite population adjustment to the variance estimate should be calculated -- the default assumes each data observation represents a unique site but this default can be overridden with the `fpcsize` argument.

To view the output, run
```{r}
tnt_extent
```

The `*.P` columns represent percentages, and the `*.U` columns represent totals (relative to the weighting units).

Next, you will subset the data to only include lakes in the target population that are not missing:
```{r}
NLA_West_Target <- na.omit(subset(NLA_West, TNT_CAT == "Target"))
```

Then you can analyze the phosphorus condition class (`PHOSPHORUS_COND`) of lakes in the target population by running
```{r}
phos_cond <- cat_analysis(
  dframe = NLA_West_Target,
  vars = "PHOSPHORUS_COND",
  weight = "WGT_TP_CORE",
  xcoord = "XCOORD",
  ycoord = "YCOORD",
  popcorrect = TRUE,
)
```

* `dframe` is `NLA_West_Target`, the design frame for the target population.
* `vars` is `"PHOSPHORUS_COND"` the variable representing the `Target` vs `NonTarget` lakes.
* `weight` is `"WGT_TP_CORE"`, the weight representing the target population that can be sampled.
* `xcoord` is the  x-coordinate (longitude) in `dframe` (this does not need to be supplied if `dframe` is also an `sf` object)
* `ycoord` is the  x-coordinate (latitude) in `dframe` (this does not need to be supplied if `dframe` is also an `sf` object)
* `popcorrect` indicates a finite population adjustment to the variance estimate should be calculated -- the default assumes each data observation represents a unique site but this default can be overridden with the `fpcsize` argument.

To view the output, run
```{r}
print(phos_cond)
```

To analyze the phosphorus condition class separately for the urban and non-urban subpopulations (`URBN_NLA17`), run
```{r}
phos_cond_subpop <- cat_analysis(
  dframe = NLA_West_Target,
  vars = "PHOSPHORUS_COND",
  subpops = "URBN_NLA17",
  weight = "WGT_TP_CORE",
  xcoord = "XCOORD",
  ycoord = "YCOORD",
  popcorrect = TRUE
)
```

* `subpops` is `"URBN_NLA17", the variable representing the subpopulation (urban vs non-urban).

To view the output, run
```{r}
print(phos_cond_subpop)
```

## Continuous variable analysis using `cont_analysis()`

The `cont_analysis()` function returns a data frame containing a suite of information regarding the categorical variable in question. Each row contains information regarding several variables; see `?cont_analysis()` for more information.

First, you will analyze Benthic MMI (`BENTHIC_MMI`) by running
```{r}
bmmi <- cont_analysis(
  dframe = NLA_West_Target,
  vars = "BENTHIC_MMI",
  weight = "WGT_TP_CORE",
  xcoord = "XCOORD",
  ycoord = "YCOORD",
  popcorrect = TRUE
)
```

* `dframe` is `NLA_West_Target`, the design frame for the target population.
* `vars` is `"BENTHIC_MMI"` the variable representing benthic MMI measurements at each lake.
* `weight` is `"WGT_TP_CORE"`, the weight representing the target population that can be sampled.
* `xcoord` is the  x-coordinate (longitude) in `dframe` (this does not need to be supplied if `dframe` is also an `sf` object)
* `ycoord` is the  x-coordinate (latitude) in `dframe` (this does not need to be supplied if `dframe` is also an `sf` object)
* `popcorrect` indicates a finite population adjustment to the variance estimate should be calculated -- the default assumes each data observation represents a unique site but this default can be overridden with the `fpcsize` argument.

There are two types of output: a brief CDF analysis (`CDF`) and a analysis of several commonly used quantiles of the variable in question. To view the first few rows of each type of output, run
```{r}
head(bmmi$CDF)
```

```{r}
head(bmmi$Pct)
```

To analyze Benthic MMI (`BENTHIC_MMI`) for the urban vs non-urban subpopulation (`URBN_NLA17`), run
```{r}
bmmi_subpop <- cont_analysis(
  dframe = NLA_West_Target,
  vars = "BENTHIC_MMI",
  subpops = "URBN_NLA17"
  weight = "WGT_TP_CORE",
  xcoord = "XCOORD",
  ycoord = "YCOORD",
  popcorrect = TRUE
)
```

To view the first few rows of each type of output, run
```{r}
head(bmmi_subpop$CDF)
```

```{r}
head(bmmi_subpop$Pct)
```

