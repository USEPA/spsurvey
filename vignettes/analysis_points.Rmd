---
title: "Analyzing Samples from a Finite Population using spsurvey"
author: "Michael Dumelle, Tony Olsen, Tom Kincaid, and Marc Weber"
output: 
  html_document:
    theme: flatly
    number_sections: true
    highlighted: default 
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    toc_depth: 2
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  warning = FALSE, 
  message = FALSE
)
library(devtools)
load_all()
data("NLA_West")
```


# Introduction

In this vignette, you will use `spsurvey` to analyze probability samples of a finite resource. You will explore:

* [The `NLA_West` Data]
* [Categorical Variable Analysis]
* [Continuous Variable Analysis]

If you have not yet done so, please read the "Start Here" vignette, accessed [here](dummy link for now) or by running `vignette("start_here", package = "spsurvey")`. In this vignette, you will review Coordinate Reference Systems (CRS), `sf` objects, installing and loading the `spsurvey` package, setting a reproducible seed, and using the "pipe" operator (`%>%`).

# The `NLA_West` Data

Before anything else, you must load `spsurvey` by running
```{r setup, eval = FALSE}
library(spsurvey)
```

Then, you can load the `NLA_West` data by running 
```{r}
data("NLA_West")
```


# Analyzing GRTS Probability Samples

In this portion of the vignette, you will learn how to analyze your GRTS samples. You will analyze categorical variables using the `cat_analysis()` function, and you will analyze continuous variables using the `cont_analysis()` function. There are several required arguments to the `cat_analysis()` and `cont_analysis()` functions.

* `dframe`: A data frame containing variables whose names match those from the `vars`, `siteid`, `weight`, `xcoord`, and `ycoord` arguments.
* `vars`: A character string indicating the name(s) of the response variable(s) in `dframe` to be analyzed.
* `siteid`: A character string indicating the name of the site indicator variable in `dframe`.
* `weight`: A character string indicating the name of the survey design weights variable in `dframe`.
* `xcoord`: A character string indicating the name of the x-coordinate variable in `dframe`.
* `ycoord`: A character string indicating the name of the y-coordinate variable in `dframe`.

There are two types of data objects that can be used with `cat_analysis()`: an `sf` object or a standard `data.frame`. If an `sf` object is used, the `xcoord` and `ycoord` arguments to the `cat_analysis()` and `cont_analysis()` functions are not required. There are several other optional arguments available to `cat_analysis()` and `cont_analysis()` that provide further customization of your analysis; you can run `?cat_analysis()` and `?cont_analysis()` for more information.

## `cat_analysis()`

The `cat_analysis()` function returns a data frame containing a suite of information regarding the categorical variable in question. Each row contains information regarding several variables:

* `Type`: The variable type. If no subpopulations are analyzed, this will correspond to all sites. If a subpopulation is analyzed, this will correspond to the name of the subpopulation variables.
* `Subpopulation`: The level of the subpopulation variable.
* `Indicator`: The indicator variable analyzed.
* `Category`: The level of the indicator variable.
* `nResp`: The number of samples.
* `Estimate.P`: The estimated proportion of population units in this `Category`.
* `StdError.P`:  The standard error for `Estimate.P`.
* `MarginofError.P`: The margin of error for `Estimate.P`.
* `LCB95Pct.P`: The lower bound of a 95% confidence interval for `Estimate.P`.
* `UCB95Pct.P`: The upper bound of a 95% confidence interval for `Estimate.P`.
* `Estimate.U`: The estimated total of population units in this `Category`.
* `StdError.U`:  The standard error for `Estimate.U`.
* `MarginofError.U`: The margin of error for `Estimate.U`.
* `LCB95Pct.U`: The lower bound of a 95% confidence interval for `Estimate.U`.
* `UCB95Pct.U`: The upper bound of a 95% confidence interval for `Estimate.U`.

Here you store the base site output from the single strata, equal probability sample as a `data.frame` by manually taking the geometry from the `sf` object and storing the coordinate information as rows in a `data.frame`. 
```{r}
eqprob_base <- cbind(st_drop_geometry(eqprob$sites.base), st_coordinates(eqprob$sites.base))
```

Now, you can run the analysis on the `"Chla_cond"` variable:
```{r}
eqprob_chlacond <- cat_analysis(dframe = eqprob_base,  vars = "Chla_cond", siteID = "siteID",
                                weight = "wgt", xcoord = "X", 
                                ycoord = "Y")
```

To view the analysis results, run:
```{r}
eqprob_chlacond
```

To rerun the analysis treating `"PTL_cond"` as a subpopulation variable, run:
```{r}
eqprob_chlacond_sp <- cat_analysis(dframe = eqprob_base,  vars = "Chla_cond", siteID = "siteID",
                                subpop = "PTL_cond", weight = "wgt", xcoord = "X", 
                                ycoord = "Y")
```

To run an analysis incorporating the `"Lake_Origin"` stratafied design, you will first store the base site output from the stratified, equal probability sample as a `data.frame` by manually taking the geometry from the `sf` object and storing the coordinate information as rows in a `data.frame`. 
```{r}
strat_eqprob_base <- cbind(st_drop_geometry(strat_eqprob$sites.base), st_coordinates(strat_eqprob$sites.base))
```

Now, you can run the analysis on the `"Chla_cond"` variable:
```{r}
strat_eqprob_chlacond <- cat_analysis(dframe = strat_eqprob_base,  vars = "Chla_cond", siteID = "siteID",
                                stratumID = "Lake_Origin", weight = "wgt", xcoord = "X", 
                                ycoord = "Y")
```

To view the analysis results, run:
```{r}
strat_eqprob_chlacond
```


## `cont_analysis()`

```{r}
eqprob_chla <- cont_analysis(dframe = NLA_West, vars = "BENTHIC_MMI",
                                weight = "WGT_TP_EXTENT", xcoord = "XCOORD", siteID = "SITE_ID",
                                ycoord = "YCOORD")


eqprob_chla <- cat_analysis(dframe = NLA_West, vars = "BENTHIC_MMI_COND",
                                weight = "WGT_TP_EXTENT", xcoord = "XCOORD", siteID = "SITE_ID",
                                ycoord = "YCOORD")
```

```{r}
eqprob_chla$CDF
eqprob_chla$Pct
```